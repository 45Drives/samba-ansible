---
- name: configure for cephfs as backend fs
  debug:
    msg: "configured cephfs as backend fs"

- name: print client name
  debug:
    msg: "{{ cephfs_samba_keyring[0].name.split('.') | last }}"

- name: configure_cephfs_backend | Create directory for samba shares
  shell: /usr/bin/cephfs-shell "mkdir -m 755 -p /{{ cephfs_samba_keyring[0].name.split('.') | last }}"
  run_once: true
  delegate_to: "{{ groups.mons[0] }}"

- name: configure_cephfs_backend | Get samba secret for cephfs mount
  command: "ceph auth get-key {{ cephfs_samba_keyring[0].name }}"
  register: command_output_samba
  changed_when: false
  delegate_to: "{{ groups.mons[0] }}"

- name: configure_cephfs_backend | Set samba secret fact
  set_fact:
    cephfs_samba_secret: "{{ command_output_samba.stdout }}"

- name: configure_cephfs_backend | write ceph samba client secret
  copy:
    content: "{{ cephfs_samba_secret }}"
    dest: /etc/ceph/{{ cephfs_samba_keyring[0].name.split('.') | last }}.secret
    force: yes
    group: ceph
    owner: ceph
    mode: "0600"

- name: mount_cephfs | create local directory for share mount
  file:
    path: "{{ shared_storage_mountpoint }}"
    owner: "root"
    group: "root"
    mode: '0775'
    state: directory
  run_once: true

- name: mount_cephfs | mount share
  mount:
    name: "{{ shared_storage_mountpoint }}"
    src: ":/{{ cephfs_samba_keyring[0].name.split('.') | last }}"
    fstype: "ceph"
    opts: "name={{ cephfs_samba_keyring[0].name.split('.') | last }},secretfile=/etc/ceph/{{ cephfs_samba_keyring[0].name.split('.') | last }}.secret,_netdev,relatime"
    state: mounted